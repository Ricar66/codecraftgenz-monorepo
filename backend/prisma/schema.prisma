// =============================================
// PRISMA SCHEMA - CodeCraft Gen-Z
// =============================================
// Database: MySQL (Hostinger)
// =============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// =============================================
// USERS & AUTHENTICATION
// =============================================

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  name          String
  passwordHash  String
  role          String    @default("viewer")
  status        String    @default("ativo")
  isGuest       Boolean   @default(false)
  mfaEnabled    Boolean   @default(false)
  mfaSecret     String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  apps          App[]
  payments      Payment[]
  licenses      License[]
  passwordResets PasswordReset[]
  feedbacks     Feedback[]
  crafter       Crafter?
  challengeSubmissions ChallengeSubmission[]

  @@map("users")
}

model PasswordReset {
  id        Int       @id @default(autoincrement())
  userId    Int
  email     String    
  tokenHash String    @unique 
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("password_resets")
}

// =============================================
// PROJECTS
// =============================================

model Project {
  id          Int       @id @default(autoincrement())
  nome        String
  descricao   String?
  status      String    @default("ativo")
  preco       Decimal   @default(0) @db.Decimal(10, 2)
  progresso   Int       @default(0)
  thumbUrl    String?
  tagsJson    String?   // Tecnologias do projeto em formato JSON
  mentorId    Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  mentor      Mentor?   @relation(fields: [mentorId], references: [id], onDelete: SetNull)
  apps        App[]
  inscricoes  Inscricao[]
  finances    Finance[]

  @@map("projetos")
}

// =============================================
// APPS & MARKETPLACE
// =============================================

model App {
  id              Int       @id @default(autoincrement())
  name            String    
  description     String?   
  shortDescription String?  
  price           Decimal   @default(0) @db.Decimal(10, 2)
  category        String?   
  tags            String?   
  thumbUrl        String?   
  screenshots     String?   
  executableUrl   String?
  platforms       String?   @default("windows") // JSON: ["windows","macos","linux"]
  version         String    @default("1.0.0")
  status          String    @default("draft")
  featured        Boolean   @default(false)
  downloadCount   Int       @default(0)

  creatorId       Int
  projectId       Int?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  creator         User      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  project         Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)
  purchases       Payment[]
  licenses        License[]
  feedbacks       Feedback[]

  @@map("apps")
}

// =============================================
// PAYMENTS
// =============================================

model Payment {
  id              String    @id
  appId           Int
  userId          Int?
  preferenceId    String?
  status          String    @default("pending")
  amount          Decimal   @db.Decimal(10, 2)
  unitPrice       Decimal?  @db.Decimal(10, 2)  // Preço unitário por licença
  quantity        Int       @default(1)          // Quantidade de licenças (1-10)
  installments    Int       @default(1)          // Número de parcelas (1-4)
  currency        String    @default("BRL")
  payerEmail      String?
  payerName       String?
  mpResponseJson  String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  app             App       @relation(fields: [appId], references: [id], onDelete: Cascade)
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([appId, status])
  @@index([payerEmail])
  @@map("app_payments")
}

// =============================================
// LICENSES
// =============================================

model License {
  id              Int       @id @default(autoincrement())
  appId           Int
  userId          Int?
  email           String    
  hardwareId      String?   
  licenseKey      String?   
  appName         String?   
  activatedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  app             App       @relation(fields: [appId], references: [id], onDelete: Cascade)
  user            User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  activations     LicenseActivation[]

  @@index([appId, email])
  @@index([appId, email, hardwareId])
  @@map("user_licenses")
}

model LicenseActivation {
  id          Int       @id @default(autoincrement())
  appId       Int
  email       String?   
  hardwareId  String?   
  licenseId   Int?
  action      String    
  status      String    
  message     String?   
  ip          String?   
  userAgent   String?   
  createdAt   DateTime  @default(now())

  license     License?  @relation(fields: [licenseId], references: [id], onDelete: SetNull)

  @@index([appId, email])
  @@index([hardwareId])
  @@map("license_activations")
}

// =============================================
// CRAFTERS & TEAMS
// =============================================

model Crafter {
  id          Int       @id @default(autoincrement())
  nome        String
  email       String?
  bio         String?   @db.Text
  avatarUrl   String?   @db.Text  // Allows Base64 data URLs
  githubUrl   String?
  linkedinUrl String?
  skillsJson  String?   @db.Text
  pontos      Int       @default(0)
  equipeId    Int?
  userId      Int?      @unique
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  equipe      Equipe?   @relation(fields: [equipeId], references: [id], onDelete: SetNull)
  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  rankingTop3 RankingTop3[]

  @@map("crafters")
}

model Equipe {
  id          Int       @id @default(autoincrement())
  nome        String    
  descricao   String?   
  logoUrl     String?   
  status      String    @default("ativo") 
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  membros     Crafter[]

  @@map("equipes")
}

model RankingTop3 {
  id          Int       @id @default(autoincrement())
  crafterId   Int
  position    Int
  createdAt   DateTime  @default(now())

  crafter     Crafter   @relation(fields: [crafterId], references: [id], onDelete: Cascade)

  @@map("ranking_top3")
}

model RankingAudit {
  id          Int       @id @default(autoincrement())
  action      String
  crafterId   Int?
  userId      Int?
  oldValue    String?
  newValue    String?
  details     String?
  createdAt   DateTime  @default(now())

  @@map("ranking_audit")
}

model RankingSettings {
  id          Int       @id @default(autoincrement())
  filtersJson String?
  settingsJson String?
  updatedAt   DateTime  @updatedAt

  @@map("ranking_settings")
}

// =============================================
// MENTORS
// =============================================

model Mentor {
  id          Int       @id @default(autoincrement())
  nome        String
  email       String?
  bio         String?   @db.Text
  especialidade String?
  avatarUrl   String?   @db.Text  // Allows Base64 data URLs
  linkedinUrl String?
  githubUrl   String?
  disponivel  Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  projetos    Project[]

  @@map("mentores")
}

// =============================================
// INSCRIPTIONS
// =============================================

model Inscricao {
  id          Int       @id @default(autoincrement())
  nome        String    
  email       String    
  telefone    String?   
  mensagem    String?   
  projetoId   Int?
  tipo        String    @default("geral") 
  status      String    @default("pendente") 
  notas       String?   
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  projeto     Project?  @relation(fields: [projetoId], references: [id], onDelete: SetNull)

  @@map("inscricoes")
}

// =============================================
// CHALLENGES
// =============================================

model Desafio {
  id          Int       @id @default(autoincrement())
  name        String    
  objective   String?   
  description String?   
  difficulty  String    @default("medio") 
  deadline    DateTime?
  reward      Decimal?  @db.Decimal(10, 2)
  basePoints  Int       @default(100)
  tagsJson    String?   
  deliveryType String   @default("link") 
  thumbUrl    String?   
  status      String    @default("active") 
  visible     Boolean   @default(true)
  createdBy   Int?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  submissions ChallengeSubmission[]

  @@map("desafios")
}

model ChallengeSubmission {
  id            Int       @id @default(autoincrement())
  desafioId     Int
  oderId        Int
  deliveryUrl   String?   
  deliveryText  String?   
  notes         String?   
  status        String    @default("subscribed") 
  score         Int?
  reviewFeedback String?  
  submittedAt   DateTime?
  reviewedAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  desafio       Desafio   @relation(fields: [desafioId], references: [id], onDelete: Cascade)
  user          User      @relation(fields: [oderId], references: [id], onDelete: Cascade)

  @@unique([desafioId, oderId])
  @@map("challenge_submissions")
}

// =============================================
// FINANCE
// =============================================

model Finance {
  id          Int       @id @default(autoincrement())
  item        String
  valor       Decimal   @db.Decimal(10, 2)
  status      String?   @default("pending")
  type        String?   @default("other")
  projectId   Int?
  progress    Int?      @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project     Project?  @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@map("financas")
}

// =============================================
// FEEDBACK
// =============================================

model Feedback {
  id          Int       @id @default(autoincrement())
  userId      Int?
  appId       Int?
  rating      Int
  comment     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user        User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  app         App?      @relation(fields: [appId], references: [id], onDelete: SetNull)

  @@map("feedbacks")
}

// =============================================
// B2B PROPOSALS
// =============================================

model Proposal {
  id            String    @id @default(uuid())
  companyName   String
  contactName   String
  email         String
  phone         String?
  projectType   String    @default("custom")
  budgetRange   String?
  description   String?   @db.Text
  status        String    @default("new")
  notes         String?   @db.Text
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([status])
  @@index([email])
  @@map("proposals")
}
